# LegalEase Backend Directory Structure

**Version:** 1.1
**Date:** April 1, 2023
**Author:** LegalEase Development Team
**Status:** Approved

---

**Note: these are the sample guide You don't have to stict to the guideline, adjust as required based on this guideline**

## 1. Introduction

This document outlines the standard directory structure for the LegalEase backend application. The backend is built using Node.js, Express.js, and TypeScript, interacting with Supabase (PostgreSQL), Redis, AWS S3, and Elasticsearch. Following this structure promotes consistency, maintainability, and scalability while ensuring the platform meets the specialized needs of legal professionals.

> **For complete technical stack details, see [technical-stack.md](technical-stack.md)**  
> **For frontend structure information, see [file-structure.md](file-structure.md)**  
> **For application workflows, see [app-flow-document.md](app-flow-document.md)**

---

## 2. Top-Level Structure

```
legal-ease-backend/
├── dist/                   # Compiled TypeScript output (usually excluded from Git)
├── src/                    # Main source code directory
├── tests/                  # Test files (unit, integration, e2e)
├── .env                    # Environment variables (ignored by git)
├── .env.example            # Example environment variables file
├── .eslintrc.js            # ESLint configuration
├── .gitignore              # Git ignore rules
├── .prettierrc.js          # Prettier configuration
├── Dockerfile              # Docker build configuration
├── nodemon.json            # Nodemon configuration for development restarts
├── package.json            # Project dependencies and scripts
├── tsconfig.json           # TypeScript compiler configuration
└── README.md               # Backend-specific README (or integrated into main)
```

*   **`dist/`**: Contains the compiled JavaScript code generated by the TypeScript compiler (`tsc`). This directory is typically not committed to version control.
*   **`src/`**: Holds all the application's source code written in TypeScript, organized by feature domains relevant to legal practice management.
*   **`tests/`**: Contains all automated tests, mirroring the `src` directory structure, with 80% minimum coverage as specified in [technical-stack.md](technical-stack.md).
*   **Configuration Files (`.env`, `.eslintrc.js`, etc.)**: Standard configuration files for environment variables, linting, formatting, Docker, etc.
*   **`package.json`**: Defines project metadata, dependencies, and scripts for the Node.js environment.
*   **`tsconfig.json`**: Configures the TypeScript compiler options with strict typing enabled.

---

## 3. `src/` Directory Structure

The `src` directory is the heart of the backend application and is organized to separate concerns and group related logic by feature domains specific to legal practice management.

```
src/
│
├── app.ts                # Central Express application setup (middleware, routes)
├── server.ts             # HTTP server initialization and startup logic
│
├── config/               # Application configuration loader
│   ├── index.ts          # Exports consolidated configuration
│   ├── environment.ts    # Environment variable loading and validation (using zod)
│   ├── database.config.ts# Supabase database specific configurations
│   ├── redis.config.ts   # Redis specific configurations for caching and session management
│   ├── aws.config.ts     # AWS S3 specific configurations for document storage
│   ├── elasticsearch.config.ts # Elasticsearch configurations for document/matter search
│   └── logger.config.ts  # Logging configurations for audit trails and debugging
│
├── features/             # Core application features/domains specific to legal practice
│   │                     # (Each feature typically follows a similar pattern)
│   ├── auth/             # Authentication and Authorization
│   │   ├── auth.controller.ts # Handles incoming HTTP requests for auth
│   │   ├── auth.routes.ts     # Defines API endpoints for auth
│   │   ├── auth.service.ts    # Contains business logic for auth
│   │   ├── auth.validation.ts # Request validation schemas (using Zod)
│   │   └── auth.types.ts      # TypeScript types specific to auth
│   │
│   ├── users/            # User management for attorneys, paralegals, admins
│   │   ├── user.controller.ts
│   │   ├── user.routes.ts
│   │   ├── user.service.ts
│   │   ├── user.repository.ts # Data access logic for users (Supabase)
│   │   └── user.types.ts      # Includes role definitions and permissions
│   │
│   ├── matters/          # Case/Matter Management (core of legal practice)
│   │   ├── matter.controller.ts
│   │   ├── matter.routes.ts
│   │   ├── matter.service.ts
│   │   ├── matter.repository.ts # Data access logic for matters
│   │   ├── matter.validation.ts
│   │   └── matter.types.ts      # Includes matter status, practice areas, etc.
│   │
│   ├── documents/        # Document Management with legal-specific metadata
│   │   ├── document.controller.ts
│   │   ├── document.routes.ts
│   │   ├── document.service.ts    # Includes logic for S3 uploads/retrievals
│   │   ├── document.repository.ts # Data access logic for document metadata
│   │   ├── document.validation.ts
│   │   └── document.types.ts      # Document types, categories, metadata schema
│   │
│   ├── billing/          # Billing, Invoicing, Time Tracking
│   │   ├── billing.controller.ts
│   │   ├── billing.routes.ts      # Routes for time entries, invoices, payments
│   │   ├── billing.service.ts     # Billing calculations, invoice generation
│   │   ├── billing.repository.ts  # Data access for time, invoices, etc.
│   │   ├── billing.validation.ts
│   │   └── billing.types.ts       # Billing types, rate structures, invoice status
│   │
│   ├
│   │   
│   │   
│   │    
│   │   
│   │   
│   │   
│   │
│   ├── calendar/         # Scheduling & Calendar Management with court date tracking
│   │   ├── calendar.controller.ts
│   │   ├── calendar.routes.ts
│   │   ├── calendar.service.ts    # Includes court date calculations
│   │   ├── calendar.repository.ts
│   │   ├── calendar.validation.ts
│   │   └── calendar.types.ts      # Event types, reminder settings
│   │
│   ├── clients/          # Client/Contact Management (CRM)
│   │   ├── client.controller.ts
│   │   ├── client.routes.ts
│   │   ├── client.service.ts
│   │   ├── client.repository.ts
│   │   ├── client.validation.ts
│   │   └── client.types.ts        # Client types, conflict checking
│   │
│   ├── portal/           # Client Portal specific endpoints
│   │   ├── portal.controller.ts
│   │   ├── portal.routes.ts
│   │   ├── portal.service.ts      # Limited access services for client users
│   │   ├── portal.repository.ts
│   │   ├── portal.validation.ts
│   │   └── portal.types.ts
│   │
│   ├── reports/          # Reporting & Analytics
│   │   ├── report.controller.ts
│   │   ├── report.routes.ts
│   │   ├── report.service.ts      # Generates reports with legal metrics
│   │   ├── report.repository.ts
│   │   └── report.types.ts
│   │
│   └── integrations/     # Third-party legal integrations
│       ├── courts/       # Court filing systems
│       ├── research/     # Legal research platforms (Westlaw, LexisNexis)
│       ├── esign/        # E-signature services (DocuSign, HelloSign)
│       ├── accounting/   # Accounting software (QuickBooks, Xero)
│       └── calendar/     # Calendar integrations (Google, Outlook)
│
├── middleware/           # Custom Express middleware
│   ├── auth.middleware.ts    # JWT verification, role-based access control
│   ├── error.middleware.ts   # Centralized error handling
│   ├── validation.middleware.ts # Middleware to run Zod validations
│   ├── rateLimiter.middleware.ts # API rate limiting for security
│   ├── logger.middleware.ts  # Request/response logging (Morgan)
│   └── audit.middleware.ts   # Activity logging for compliance tracking
│
├── services/             # Shared, infrastructure-level services
│   ├── logger.service.ts   # Centralized logging instance (Winston)
│   ├── redis.service.ts    # Redis client wrapper/functions
│   ├── s3.service.ts       # AWS S3 client wrapper with security features
│   ├── email.service.ts    # Email service with templates for legal notifications
│   ├── search.service.ts   # Elasticsearch client for document/matter search
│   ├── pdf.service.ts      # PDF generation for legal documents
│   ├── notification.service.ts # Notifications for deadlines and events
│   └── cache.service.ts    # Abstraction over Redis for application caching
│
├── types/                # Global TypeScript types and interfaces
│   ├── index.d.ts        # Global type declarations
│   ├── express.d.ts      # Augment Express Request/Response types (e.g., req.user)
│   ├── legal.d.ts        # Legal-specific type definitions
│   └── supabase.d.ts     # Type definitions for Supabase schema
│
├── utils/                # General utility functions and constants
│   ├── apiResponse.ts    # Standardized API response structure
│   ├── errorHandler.ts   # Custom error classes with legal-specific codes
│   ├── constants.ts      # Application-wide constants
│   ├── dateUtils.ts      # Date handling for legal deadlines
│   ├── formatters.ts     # Formatting helpers for legal data
│   └── validators.ts     # Custom validation helpers
│
└── database/             # Database-specific setup
    ├── supabaseClient.ts # Singleton Supabase client instance setup
    ├── schema/           # Database schema definitions
    ├── migrations/       # Database migration files
    └── seeds/            # Database seeding scripts for development

```

> **Note:** The features identified in this structure is a guideline, create as it required when needed and directly map to the core functional requirements outlined in [product-requirement.md](product-requirement.md).

---

## 4. Key Components Explained

*   **`app.ts`**: Initializes the Express app, applies global middleware (CORS, body-parser, request logging), mounts feature routers, and sets up global error handling for the LegalEase API.
*   **`server.ts`**: Imports the `app`, creates an HTTP server, listens on a specified port, and handles graceful shutdown with connection termination handling.
*   **`config/`**: Loads and centralizes configuration from environment variables or files. Ensures required configurations are present, with special attention to security settings for legal data.
*   **`features/[featureName]/`**: Organizes code by legal domain/feature, following a consistent pattern:
    *   **`.routes.ts`**: Defines API endpoints using Express Router. Maps routes to controller methods and applies route-specific middleware (validation, auth).
    *   **`.controller.ts`**: Handles incoming requests and outgoing responses. Parses request data, calls service methods, and formats responses using `apiResponse.ts`.
    *   **`.service.ts`**: Contains the core business logic for the feature. Orchestrates calls to repositories and other services, implementing legal-specific business rules.
    *   **`.repository.ts`**: Encapsulates data access logic, interacting directly with Supabase. Handles CRUD operations for the feature's domain entities with appropriate security checks.
    *   **`.validation.ts`**: Defines Zod schemas for validating request bodies, query parameters, and path parameters, with legal-specific validation rules.
    *   **`.types.ts`**: Contains TypeScript interfaces and types specific to the feature module, ensuring type safety throughout the application.

### Example Controller Implementation (Matter Management)

```typescript
// matter.controller.ts
export class MatterController {
  constructor(private matterService: MatterService) {}

  // Get matters with pagination and filtering
  async getMatters(req: Request, res: Response, next: NextFunction) {
    try {
      const userId = req.user.id; // From auth middleware
      const filters = req.query as MatterFilters;
      
      const matters = await this.matterService.getMatters(userId, filters);
      
      return res.status(200).json(
        apiResponse.success(matters, 'Matters retrieved successfully')
      );
    } catch (error) {
      next(error);
    }
  }

  // Additional controller methods for CRUD operations...
}
```

*   **`middleware/`**: Holds reusable Express middleware functions used across different routes, with special attention to authorization and audit logging for legal compliance.
*   **`services/`**: Contains shared services that provide common functionalities like logging, caching, file storage, and notifications with secure handling of sensitive legal data.
*   **`types/`**: Global type definitions for TypeScript, ensuring consistency across the application and integration with external libraries.
*   **`utils/`**: Generic helper functions, constants, and custom error classes used throughout the application, including specialized utilities for legal date calculations and formatting.
*   **`database/`**: Initializes and exports the Supabase client instance with security configurations appropriate for legal data storage.

---

## 5. Testing (`tests/` Directory)

The `tests` directory mirrors the `src` structure to make locating tests easy, with coverage requirements specified in [technical-stack.md](technical-stack.md).

```
tests/
├── features/
│   ├── matters/
│   │   ├── matter.service.test.ts
│   │   ├── matter.controller.test.ts
│   │   └── matter.routes.integration.test.ts
│   ├── documents/
│   │   ├── document.service.test.ts
│   │   └── document.routes.integration.test.ts
│   └── ... (tests for other features)
├── middleware/
│   ├── auth.middleware.test.ts
│   └── audit.middleware.test.ts
├── services/
│   ├── redis.service.test.ts
│   └── pdf.service.test.ts
├── utils/
│   ├── dateUtils.test.ts
│   └── formatters.test.ts
└── setup.ts # Global test setup (e.g., initializing test database)
```

*   **Unit Tests (`.test.ts`)**: Test individual functions, methods, or classes in isolation (e.g., testing service logic, utility functions). Use mocking for dependencies.
*   **Integration Tests (`.integration.test.ts`)**: Test the interaction between multiple components (e.g., testing a full API request flow from route to controller to service to repository).
*   **E2E Tests**: End-to-end testing is primarily handled in the frontend repository using Cypress, but the backend implements comprehensive integration tests to ensure API correctness.

### Example Test (Matter Service)

```typescript
// matter.service.test.ts
describe('MatterService', () => {
  let matterService: MatterService;
  let matterRepositoryMock: jest.Mocked<MatterRepository>;
  
  beforeEach(() => {
    matterRepositoryMock = {
      findByUserId: jest.fn(),
      findById: jest.fn(),
      create: jest.fn(),
      update: jest.fn(),
      delete: jest.fn(),
    } as any;
    
    matterService = new MatterService(matterRepositoryMock);
  });
  
  describe('getMatters', () => {
    it('should return matters for a user with applied filters', async () => {
      // Arrange
      const userId = 'user-123';
      const filters = { status: 'active', practiceArea: 'family-law' };
      const mockMatters = [{ id: 'matter-1', name: 'Smith Divorce' }];
      
      matterRepositoryMock.findByUserId.mockResolvedValue(mockMatters);
      
      // Act
      const result = await matterService.getMatters(userId, filters);
      
      // Assert
      expect(matterRepositoryMock.findByUserId).toHaveBeenCalledWith(
        userId, filters
      );
      expect(result).toEqual(mockMatters);
    });
  });
  
  // Additional tests...
});
```

---

## 6. Security Considerations

Security is paramount in LegalEase's backend implementation due to the sensitive nature of legal data:

*   **Authentication & Authorization**: Robust JWT-based authentication with role-based access control (RBAC) for different user types (attorneys, paralegals, admins, clients).
*   **Data Encryption**: All sensitive data encrypted at rest in Supabase and in transit via HTTPS.
*   **Audit Logging**: Comprehensive logging of all data modifications for compliance and security audit purposes.
*   **Input Validation**: Strict request validation using Zod schemas to prevent injection attacks.
*   **Rate Limiting**: Protection against brute force attacks and DoS attempts.
*   **Document Security**: Secure document storage in S3 with encrypted storage and access controls.

---

## 7. API Documentation

The LegalEase API is documented using Swagger/OpenAPI, which is automatically generated from code annotations and maintained as part of the CI/CD pipeline. The documentation covers:

*   **Endpoints**: All available API endpoints organized by feature domain.
*   **Request/Response Models**: Expected request formats and response structures.
*   **Authentication**: Required authentication mechanisms and token handling.
*   **Error Codes**: Standardized error codes and messages.

API documentation is accessible through a dedicated `/api-docs` endpoint in non-production environments.

---

> **Related Documentation:**
> - [product-requirement.md](product-requirement.md) - Detailed feature requirements
> - [technical-stack.md](technical-stack.md) - Complete technical stack details
> - [app-flow-document.md](app-flow-document.md) - User workflow specifications
> - [file-structure.md](file-structure.md) - Overall project organization

*This document serves as the definitive guide for LegalEase backend development. The structure may evolve as the application grows, but should maintain the core organizational principles outlined here.* 